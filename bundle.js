(()=>{"use strict";window.util={isEscEvent:(e,t)=>{27===e.keyCode&&t()},isClickEvent:e=>{e()},isEnterEvent:(e,t)=>{13===e.keyCode&&t()},isMainMouseButtonEvent:(e,t)=>{0===e.button&&t()},getRandomIntInclusive:(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1))+e),getRandomElement:e=>e[window.util.getRandomIntInclusive(0,e.length-1)],getMaxElement:e=>{const t=e[0];for(let n=1;n<e.length;n++)t=Math.max(t,e[n]);return t},renderChildren:(e,t,n,o=window.remove.removeChildren)=>{o(e);const r=document.createDocumentFragment();t.forEach((e=>{const t=n(e);r.appendChild(t)})),e.appendChild(r)},forEach:(e,t)=>Array.prototype.forEach.call(e,t)},window.remove={removeCard:()=>{const e=document.querySelector(".popup");e&&e.remove(),document.removeEventListener("keydown",window.card.onEscPressCloseCard),window.map.removeClassActivePin()},removeChildren:e=>{for(;e.firstChild;)e.firstChild.remove()}},(()=>{const e=document.querySelector(".map__pin--main"),t=e=>{window.util.isMainMouseButtonEvent(e,window.activate.activatePage)},n=e=>{window.util.isEnterEvent(e,window.activate.activatePage)};window.pin={moveToStartPosition:()=>{e.style.left="570px",e.style.top="375px"},removeEventListenersOnPin:()=>{e.removeEventListener("mousedown",t),e.removeEventListener("keydown",n)},addEventListenersOnPin:()=>{e.addEventListener("mousedown",t),e.addEventListener("keydown",n)},removePins:()=>{document.querySelectorAll(".map__pin").forEach((t=>{t!==e&&t.remove()}))}}})(),(()=>{const e=document.querySelector("main"),t=e.querySelector(".map__pin--main"),n=document.querySelector("#error").content.querySelector(".error"),o=document.querySelector("#success").content.querySelector(".success"),r=e=>{window.util.isClickEvent(s.bind(null,e))},i=(e,t)=>{window.util.isEscEvent(t,s.bind(null,e))},a=(e,t)=>{window.util.isEnterEvent(t,s.bind(null,e))},s=e=>{e&&e.remove(),window.pin.addEventListenersOnPin(),t.disabled=!1},d=(n,o,s,d)=>{const l=o.cloneNode(!0);n&&(l.querySelector(s).textContent=n),window.pin.removeEventListenersOnPin(),t.disabled=!0,d&&l.querySelector(d).addEventListener("keydown",a.bind(null,l)),document.addEventListener("mousedown",r.bind(null,l)),document.addEventListener("keydown",i.bind(null,l)),e.insertAdjacentElement("afterbegin",l)};window.popup={onError:e=>{d(e,n,".error__message",".error__button")},showSuccesPopup:()=>{d(null,o,null,null)}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking",t="https://21.javascript.pages.academy/keksobooking/data",n="GET",o="POST",r=(e,t,o,r=n,i)=>{const a=new XMLHttpRequest;a.responseType="json",a.addEventListener("load",(()=>{((e,t,n)=>{200===e.status?t(e.response):n("Статус ответа: "+e.status+" "+e.statusText)})(a,t,o)})),a.timeout=1e4,((e,t)=>{e.addEventListener("error",(()=>{t("Произошла ошибка соединения")}))})(a,o),((e,t)=>{e.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+e.timeout+"мс")}))})(a,o),a.open(r,e),a.send(i)};window.sync={onDataload:(t,n)=>{r(e,n,window.popup.onError,o,t)},load:e=>{r(t,e,window.popup.onError,n,null)}}})(),(()=>{const e=45,t=40,n="Фотография жилья";window.data={createOfferFeature:e=>{const t=document.createElement("li");return t.classList.add("popup__feature","popup__feature--"+e),t},createOfferImg:o=>{const r=document.createElement("img");return r.src=o,r.classList.add("popup__photo"),r.width=e,r.height=t,r.alt=n,r}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters-container"),n=document.querySelector("#pin").content.querySelector(".map__pin"),o=()=>{const t=e.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active")};window.map={renderPinOnMap:e=>{const t=n.cloneNode(!0),r=e.location.x-25,i=e.location.y-70;t.style.left=r+"px",t.style.top=i+"px";const a=t.querySelector("img");a.src=e.author.avatar,a.alt=e.offer.title;const s=()=>{o(),window.remove.removeCard(),t.classList.add("map__pin--active"),window.map.renderCardOnMap(e)};return t.addEventListener("click",(()=>{s()})),t.addEventListener("keydown",(e=>{window.util.isEnterEvent(e,s)})),t},renderCardOnMap:n=>{e.insertBefore(window.card.renderCard(n),t)},removeClassActivePin:o}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form").elements.address;e.addEventListener("mousedown",(n=>{n.preventDefault();let o={x:n.clientX,y:n.clientY};const r=n=>{const r=o.x-n.clientX,i=o.y-n.clientY;o={x:n.clientX,y:n.clientY};let a=e.offsetLeft-r;a<-31?a=-31:a>1169&&(a=1169);let s=e.offsetTop-i;s<52?s=52:s>552&&(s=552),((n,o)=>{var r;e.style.left=n+"px",e.style.top=o+"px",t.value=(r=o,`${n+Math.ceil(31)}, ${r+78}`)})(a,s)},i=e=>{e.preventDefault(),r(e)},a=e=>{e.preventDefault(),r(e),document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",a)}))})(),(()=>{const e={bungalow:"Бунгало",flat:"Квартира",house:"Дом",palace:"Дворец"},t=document.querySelector("#card").content.querySelector(".map__card"),n=e=>{window.util.isEscEvent(e,window.remove.removeCard)},o=()=>{window.remove.removeCard()},r=e=>{window.util.isEnterEvent(e,window.remove.removeCard)};window.card={renderCard:i=>{const a=t.cloneNode(!0),s=a.querySelector(".popup__title"),d=a.querySelector(".popup__text--address"),l=a.querySelector(".popup__text--price"),c=a.querySelector(".popup__type"),u=a.querySelector(".popup__text--capacity"),m=a.querySelector(".popup__text--time"),p=a.querySelector(".popup__description"),w=a.querySelector(".popup__avatar");i.offer.title&&(s.textContent=i.offer.title),i.offer.address&&(d.textContent=i.offer.address),i.offer.price&&(l.textContent=i.offer.price+"₽/ночь"),i.offer.type&&(c.textContent=e[i.offer.type]),i.offer.rooms&&(u.textContent=`${i.offer.rooms} комнаты для ${i.offer.guests} гостей`),i.offer.checkin&&i.offer.checkout&&(m.textContent=`Заезд после ${i.offer.checkin}, выезд до ${i.offer.checkout}`),window.util.renderChildren(a.querySelector(".popup__features"),i.offer.features,window.data.createOfferFeature),p.textContent=i.offer.description,window.util.renderChildren(a.querySelector(".popup__photos"),i.offer.photos,window.data.createOfferImg),w.src=i.author.avatar;const v=a.querySelector(".popup__close");return document.addEventListener("keydown",n),v.addEventListener("click",o),v.addEventListener("keydown",r),a},onEscPressCloseCard:n}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),o=n.elements.address,r=document.querySelector(".map__filters"),i=(e,t)=>{window.util.forEach(e.elements,(e=>{e.disabled=t}))},a=()=>{o.value=((e,n,o)=>{const r=parseInt(t.style.left,10),i=parseInt(t.style.top,10);return`${r+Math.ceil(32.5)}, ${i+Math.ceil(32.5)}`})()};window.disable={disablePage:t=>{t?(e.classList.add("map--faded"),n.classList.add("ad-form--disabled"),window.pin.removePins(),window.remove.removeCard()):(e.classList.remove("map--faded"),n.classList.remove("ad-form--disabled")),i(n,t),i(r,t),a()},getCoordMainPin:a}})(),window.debounce=e=>{let t;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},(()=>{let e=[];window.adsData={get:()=>e,set:t=>{e=t}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=document.querySelector(".map__filters"),n=t.querySelector("#housing-type"),o=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),a=t.querySelector(".map__features");let s={"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any","filter-wifi":"any","filter-dishwasher":"any","filter-parking":"any","filter-washer":"any","filter-elevator":"any","filter-conditioner":"any"};const d={any:{min:0,max:1/0},low:{min:0,max:9999},middle:{min:1e4,max:49999},high:{min:5e4,max:1/0}},l=e=>"any"===e,c=(e,t)=>("any"!==t&&(t=parseInt(t,10)),l(t)||e===t),u=(e,t)=>l(t)||e.includes(t),m=e=>{return t=e.offer.type,n=s["housing-type"],(l(n)||t===n)&&((e,t)=>{let n=d[t].min,o=d[t].max;return l(t)||n<=e&&e<=o})(e.offer.price,s["housing-price"])&&c(e.offer.rooms,s["housing-rooms"])&&c(e.offer.guests,s["housing-guests"])&&u(e.offer.features,s["filter-wifi"])&&u(e.offer.features,s["filter-dishwasher"])&&u(e.offer.features,s["filter-parking"])&&u(e.offer.features,s["filter-washer"])&&u(e.offer.features,s["filter-elevator"])&&u(e.offer.features,s["filter-conditioner"]);var t,n},p=()=>((e,t,n)=>{const o=[];for(let n=0;n<e.length&&5!==o.length;n++){const r=e[n];t(r,n,e)&&o.push(r)}return o})(window.adsData.get(),m),w=window.debounce((()=>{const t=p();window.remove.removeCard(),window.util.renderChildren(e,t,window.map.renderPinOnMap,window.pin.removePins)})),v=e=>{"checkbox"===e.target.type?(e=>{s[e.target.id]=s[e.target.id]!==e.target.value?e.target.value:"any"})(e):s[e.target.name]=e.target.value,w()};n.addEventListener("change",v),o.addEventListener("change",v),r.addEventListener("change",v),i.addEventListener("change",v),a.addEventListener("change",v),window.filter={resetCurrentFilter:()=>{s={"housing-type":"any","housing-price":"any","housing-rooms":"any","housing-guests":"any","filter-wifi":"any","filter-dishwasher":"any","filter-parking":"any","filter-washer":"any","filter-elevator":"any","filter-conditioner":"any"}},getFilteredAds:p}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector(".map__pin--main"),n=n=>{const o=n.filter((e=>e.offer));window.adsData.set(o);const r=window.filter.getFilteredAds();window.util.renderChildren(e,r,window.map.renderPinOnMap,window.pin.removePins),window.disable.disablePage(!1),window.form.onFormChange(!0),window.reset.onResetButton(),window.pin.removeEventListenersOnPin(),t.disabled=!1};window.pin.addEventListenersOnPin(),window.disable.disablePage(!0),window.activate={activatePage:()=>{window.sync.load(n)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector(".ad-form__reset"),n=document.querySelector(".map__filters"),o=()=>{window.disable.disablePage(!0),e.reset(),n.reset(),window.pin.moveToStartPosition(),window.disable.getCoordMainPin(),window.form.onFormChange(!1),window.filter.resetCurrentFilter()},r=()=>{o(),window.pin.addEventListenersOnPin()},i=e=>{window.util.isEnterEvent(e,o)};window.reset={resetPage:o,onResetButton:()=>{t.addEventListener("click",r),t.addEventListener("click",i)}}})(),(()=>{const e={bungalow:0,flat:1e3,house:5e3,palace:1e4},t=document.querySelector(".ad-form"),n=t.elements.room_number,o=t.elements.capacity,r=t.elements.title,i=t.elements.type,a=t.elements.price,s=t.elements.timein,d=t.elements.timeout,l=e=>{e?d.value=s.value:s.value=d.value},c=e=>{const t=parseInt(n.value,10),r=parseInt(o.value,10);t<r?e.setCustomValidity(`Для ${r} гостей нужно минимум ${r} комнаты`):100===t&&0!==r?e.setCustomValidity('Для "100 комнат" нужно выбрать "не для гостей"'):100!==t&&0===r?e.setCustomValidity("Не для гостей нужно выбрать 100 комнат"):e.setCustomValidity(""),e.reportValidity()},u=()=>{(()=>{const e=r.value.length;e<30?r.setCustomValidity(`Минимальная длина заголовка - 30 символов. Осталось еще ${30-e} симв.`):e>100?r.setCustomValidity(`Максимальная длина заголовка - 100 символов. Удалите лишние ${e-100} симв.`):r.setCustomValidity(""),r.reportValidity()})()},m=()=>{(()=>{const t=i.value,n=e[t];t&&(a.min=n,a.placeholder=n)})()},p=()=>{(()=>{const t=i.value,n=e[t],o=parseInt(a.value,10);o<n?a.setCustomValidity(`Минимальная цена для типа жилья  ${i.options[i.selectedIndex].text} - ${n} руб. за ночь. Увеличьте цену на ${n-o} руб.`):a.setCustomValidity(""),a.reportValidity()})()},w=()=>{l(!0)},v=()=>{l(!1)},f=()=>{c(n)},y=()=>{c(o)};t.addEventListener("submit",(e=>{window.sync.onDataload(new FormData(t),(()=>{window.reset.resetPage(),window.popup.showSuccesPopup(),window.pin.addEventListenersOnPin()})),e.preventDefault()})),window.form={onFormChange:e=>{e?(s.addEventListener("change",w),d.addEventListener("change",v),i.addEventListener("change",m),i.addEventListener("change",p),a.addEventListener("input",p),r.addEventListener("input",u),n.addEventListener("change",f),o.addEventListener("change",y)):(s.removeEventListener("change",w),d.removeEventListener("change",v),i.removeEventListener("change",m),i.removeEventListener("change",p),a.removeEventListener("input",p),r.removeEventListener("input",u),n.removeEventListener("change",f),o.removeEventListener("change",y))}}})()})();